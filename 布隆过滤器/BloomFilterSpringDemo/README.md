# 布隆过滤器结合springboot做查询实例

本项目采用SpringAOP和Redis来实现以下功能
1. 搜索前判断元素是否存在
2. 保存后将元素添加进布隆过滤器中

## 使用框架
- SpringBoot
- Redisson
- Guava
- Lombok
- JUnit

## 具体步骤
### 1.创建布隆过滤器
创建布隆过滤器的方法，包含首次创建布隆过滤器，及每日定时任务重新创建布隆过滤器的逻辑。 

代码位置 -- cn.max.bloomfilter.demo.service.BloomFilterService.buildBloomFilter

#### 主要步骤：
1. 反射获取对象实体类(此处的实体类可以放入数据库中)
2. 反射获取需要加入布隆过滤器过滤的属性(此处采用注解@FilterProperty表示)
3. 从数据库中获取数据(此处将数据存入常量中)
4. 在redis中建立布隆过滤器，采用(类名 + 属性名 + new)作为key
5. 添加数据进布隆过滤器
6. 添加数据完成后，将布隆过滤器改名(类名 + 属性名 + 1)，其中1是序号
7. 删除多余的布隆过滤器(序号大于1的)

补充说明：
1. 此处模拟一个实体类/一次查询中可能有多个值需要经过布隆过滤器筛选，因此采用反射的方式。如果仅需要过滤某一个属性加入布隆过滤器(如用户名)，则不需要这么麻烦。
2. 采用反射也是为了通用，后续扩展只需要将类名存入数据库，需要过滤的属性添加注解即可。
3. 此处多余的布隆过滤器是插入数据时实时创建的，当布隆过滤器达到预测量时，需要新建一个布隆过滤器来保证容错率。若此时直接重建布隆过滤器，可能会对redis造成较大压力，因此采用直接建立一个新的布隆过滤器的形式来过滤。
4. 重建时亦可以考虑增加一些阈值，比如某个属性的布隆过滤器数量超过阈值，或者修改删除次数超过阈值，在重新创建。

### 2.搜索实现
需要过滤的接口通过AOP的前置增强过滤，若布隆过滤器不存在直接返回，不影响原有的代码逻辑

代码位置：
1. AOP -- cn.max.bloomfilter.demo.aop.BloomFilterAop.beforeFind
2. 具体过滤逻辑 -- cn.max.bloomfilter.demo.service.BloomFilterService.isExist

#### 主要步骤：
1. 反射获取实体类中需要经过布隆过滤器过滤的属性
2. 获取该属性的所有布隆过滤器
3. 每个布隆过滤器都要经过，若所有布隆过滤器都没找到，则代表该属性值不存在


### 3.插入实现
需要保存的接口通过AOP的后置增强加入元素，若布隆过滤器元素数量达到阈值，则通过新建一个布隆过滤器解决。

代码位置：
1. AOP -- cn.max.bloomfilter.demo.aop.BloomFilterAop.afterSave
2. 具体过滤逻辑 -- cn.max.bloomfilter.demo.service.BloomFilterService.insertBloomFilter

#### 主要步骤：
1. 获取布隆过滤器
2. 检查布隆过滤器的容量是否满足
3. 若不满足，则新建一个布隆过滤器，序号在上一个布隆过滤器的基础上 + 1
4. 添加元素进布隆过滤器

## demo测试方法
此处采用的是JUnit进行测试，测试前先会先清空redis，然后创建默认的布隆过滤器(模拟定时任务第一次创建布隆过滤器)，然后在进行测试

代码位置：cn.max.bloomfilter.demo.RedissonTests