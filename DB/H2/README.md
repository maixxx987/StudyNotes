# H2数据库

> H2是一个Java编写的关系型数据库，它可以被嵌入Java应用程序中使用，或者作为一个单独的数据库服务器运行。



## H2数据库的优势及特点

- 非常快，开源，且支持JDBC API
- 支持内嵌模式、服务器模式和集群
- 存储内容可以放在本地磁盘或者内存中
- 支持事务，多版本控制
- 基于浏览器的数据库客户端
- 纯Java编写，仅有一个Jar文件(2.5M)





## H2数据库的运行模式及运行方式

### 运行模式
#### 内嵌模式(Embedded Mode)

> 内嵌模式下，应用和数据库同在一个JVM中，通过JDBC进行连接。可持久化，但同时只能一个客户端连接。内嵌模式性能会比较好。



#### 服务器模式(Server Mode)

> 使用服务器模式和内嵌模式一样，只不过它可以跑在另一个进程里。



#### 混合模式

> 第一个应用以内嵌模式启动它，对于后面的应用来说它是服务器模式跑着的。混合模式是内嵌模式和服务器模式的组合。第一个应用通过内嵌模式与数据库建立连接，同时也作为一个服务器启动，于是另外的应用（运行在不同的进程或是虚拟机上）可以同时访问同样的数据。第一个应用的本地连接与嵌入式模式的连接性能一样的快，而其它连接理论上会略慢。





### 连接方式

#### 以嵌入式(本地)连接方式连接H2数据库

这种连接方式默认情况下只允许有一个客户端连接到H2数据库，有客户端连接到H2数据库之后，此时数据库文件就会被锁定，那么其他客户端就无法再连接了。

连接语法：`jdbc:h2:[file:][]<databaseName>`

例如：
- jdbc:h2:~/test            // 连接位于用户目录下的test数据库
- jdbc:h2:/data/test        // 位于系统根目录下的/data/test数据库
- jdbc:h2:./data/test       // 位于项目路径下的/data/test数据库



#### 使用TCP/IP的服务器模式(远程连接)方式连接H2数据库

这种连接方式就和其他数据库类似了，是基于Service的形式进行连接的，因此允许多个客户端同时连接到H2数据库。

连接语法：`jdbc:h2:tcp://<server>[:<port>]/[<path>]<databaseName>`

范例：`jdbc:h2:tcp://localhost/~/test`



#### H2数据库的内存模式

连接语法：`jdbc:h2:mem:<databaseName>`

H2数据库被称为内存数据库，因为它支持在内存中创建数据库和表。
注意：如果使用H2数据库的内存模式，那么我们创建的数据库和表都只是保存在内存中，一旦服务器重启，那么内存中的数据库和表就不存在了。





## SpringBoot + SpringDataJdbc集成H2数据库

> 此处基于嵌入式演示H2数据库的使用方式

### Maven中添加依赖

```xml
 <dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jdbc</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```



### 配置文件.yml

```yaml
spring:
  # H2数据库配置
  datasource:
    url: jdbc:h2:./data/test;AUTO_RECONNECT=TRUE;
    username: sa
    password: 123456
    driver-class-name: org.h2.Driver

  # H2网页控制台配置
  h2:
    console:
      # 是否开启网页控制台
      enabled: true
      # 网页控制台路径 如 localhost/h2-console
      path: /h2-console
      settings:
        # 是否允许其他客户端远程访问(包括本机的数据库客户端)
        web-allow-others: true
  sql:
    init:
      # 每次启动程序，程序都会运行resources/db/schema.sql文件，对数据库的结构进行操作。
      schema-locations: classpath:db/schema.sql
      # 每次启动程序，程序都会运行resources/db/data.sql文件，对数据库的数据操作。
#      data-locations: classpath:db/data.sql
      # 是否每次都执行初始化文件
      mode: always
```



### 数据库初始化（Schema.sql）

```sql
-- 初始化student表
CREATE TABLE IF NOT EXISTS `student`
(
    `id`          BIGINT GENERATED BY DEFAULT AS IDENTITY,
    `name`        varchar(255) NULL COMMENT '名字',
    `gender`      TINYINT      NULL COMMENT '性别',
    `age`         INT          NULL COMMENT '年龄',
    `birthday`    TIMESTAMP    NULL COMMENT '生日',
    `create_time` BIGINT       NULL COMMENT '创建时间戳',
    PRIMARY KEY (`id`)
);
```



### 实体类

```java
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;
import org.springframework.data.annotation.Id;

import java.io.Serializable;
import java.util.Date;

/**
 * @author MaxStar
 * @date 2022/11/19
 */
@Data
public class Student implements Serializable {
    @Id
    private Long id;
    private String name;
    private Integer gender;
    private Integer age;
    @JsonFormat(pattern = "yyy-MM-dd")
    private Date birthday;
    /**
     * 创建时间，采用时间戳形式
     * 若直接采用Date格式会遇到时区问题，此处暂时没找到解决方法
     */
    private Long createTime;
}
```



### Dao

```java
import lombok.AllArgsConstructor;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Map;

/**
 * @author MaxStar
 * @date 2022/11/20
 */

@Repository
@AllArgsConstructor
public class StudentDao {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    public Student findById(Long id) {
        Student student = null;
        try {
            student = jdbcTemplate.queryForObject("SELECT * FROM student WHERE id = :id ", Map.of("id", id), BeanPropertyRowMapper.newInstance(Student.class));
        } catch (EmptyResultDataAccessException e) {
            System.err.println(String.format("[StudentDao#findById]data not found, id = %d", id));
        }
        return student;
    }

    public List<Student> findAll() {
        return jdbcTemplate.query("SELECT * FROM student", BeanPropertyRowMapper.newInstance(Student.class));
    }

    public void save(Student student) {
        jdbcTemplate.update("INSERT INTO `student`(`name`, `gender`, `age`, `birthday`, `create_time`) " +
                        "VALUES (:name, :gender, :age, :birthday, :createTime)",
                Map.of("name", student.getName(),
                        "gender", student.getGender(),
                        "age", student.getAge(),
                        "birthday", student.getBirthday(),
                        "createTime", System.currentTimeMillis()));
    }

    public void deleteById(Long id) {
        jdbcTemplate.update("DELETE FROM student WHERE id = :id", Map.of("id", id));
    }
}
```



### Controller

```java
import lombok.AllArgsConstructor;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * @author MaxStar
 * @date 2022/11/19
 */
@RestController
@AllArgsConstructor
@RequestMapping("/student")
public class StudentController {

    private final StudentDao studentDao;

    @GetMapping("/findById/{id}")
    public Student findById(@PathVariable Long id) {
        return studentDao.findById(id);
    }

    @GetMapping("/findAll")
    public List<Student> findAll() {
        return studentDao.findAll();
    }

    @PostMapping("/save")
    public void save(@RequestBody Student student) {
        studentDao.save(student);
    }

    @DeleteMapping("/deletedById/{id}")
    public void deleteById(@PathVariable Long id) {
        studentDao.deleteById(id);
    }
}
```



## H2网页控制台

TODO



## 参考内容

- [H2 Database Engine](http://h2database.com/html/main.html)
- [h2database/h2database: H2 is an embeddable RDBMS written in Java. (github.com)](https://github.com/h2database/h2database)
- [H2数据库入门，看这篇就对了_不敲代码的攻城狮的博客-CSDN博客_h2数据库](https://blog.csdn.net/qq_34845394/article/details/107190256)
- [SpringBoot+JDBC+H2简单配置实现（不使用Jpa、Mybatis）_Doglovesfish的博客-CSDN博客](https://blog.csdn.net/sinat_41548988/article/details/115026460)

